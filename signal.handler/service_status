# collect and print machine statistics
# @HELP signal host status			# compact status overview
# @HELP signal host status processes		# ps aux
# @HELP signal host status packages		# list of installed packages
# @HELP signal host status volumes		# show mount options of partitions with common filesystems

packages="/etc/packages"
filesystems="ext2,ext3,ext4,vfat,squashfs,f2fs,bfs,msdos,xfs"

overview()  {
cat << EOF
hostname = $HOSTNAME
processes = $(ps ax|wc -l)
$(awk '{ print "load =", $1, $2, $3 }' /proc/loadavg)
volumes = $(printf '%s ' $(awk '$NF != 0 { print $3 }' /proc/diskstats; printf '\n'))
swappiness = $(sysctl -n vm.swappiness)
entropy = $(sysctl -n kernel.random.entropy_avail)
packages = $(wc -l < $packages)
uptime = $(read uptime _ < /proc/uptime; echo ${uptime%.*})
forks = $(awk '/processes/ {print $2}' /proc/stat)
memused = $(awk '$1 == "MemTotal:"  { used=$2 } 
                 $1 == "MemFree:"   { used-=$2 }   
                 $1 == "Buffers:"   { used-=$2 }
                 $1 == "Cached:"    { used-=$2 }
                 END  { print used*1024 }' /proc/meminfo)

EOF
}

if [[ $1 == processes ]];  then  ps aux
elif [[ $1 == packages ]]; then  cat $packages
elif [[ $1 == volumes ]];  then  mount -t $filesystems
elif [[ $1 == uptime ]];   then  uptime
elif [[ $1 == memory ]];   then  cat /proc/meminfo
else                             overview
fi
