# update local service handlers from pool.
# signal host update
# signal host update force
# signal host update pretend

last="$tmp/last_update"					# instead of writing stamp to file, consider using file date

stamp=0
[[ -f "$last" && $1 != "force" ]] && read stamp < $last
[[ $1 != "pretend" ]]; pretend="$?"

# don't have info who serves as pool? find out.
[[ -z $pool ]] && source $fragments/pool

now="$(date +%s)"
signal $pool pool updated $stamp |
while read service stamp description; do
   f="$p/service_$service"
   [[ -f $f ]] && {					# updated service on pool exists on local machine
      if [[ $service == "update" ]]; then
         warning "updated service update can't be updated from pool by running service update."
         warning "run the serafena.update script instead"
      else
         echo "$HOSTNAME: updating $service"
         ((pretend)) || {
# @TODO postponing execution of service handler while rewriting would be advisable here.
            signal "$pool" pool cat "$service" > "$f"	# therefore we want the pool version
            touch -d @"$stamp" "$f"			# set file date of updated service identical to date in pool
         }
      fi
   }
done

((pretend)) ||
echo "$now" > "$last"					# remember when last (this) update was done
