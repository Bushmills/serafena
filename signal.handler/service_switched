# power strip socket state has changed.
# socket owners signal this to odroid, for update of desktop icons 
# $1: socket owner (hostname of device with power rail connected)
# $2: socket number(1..4)
# $3: new socket state ("an", "aus")
# odroid, responding to this service, generates a new .desktop file for
# the changed socket, reflecting its updated state.

PATH="$PATH:/misc/bin"

user="l"
config="/home/$user/.power_buttons"

declare -A icon
icons="/usr/local/share/icons"
icon[an]="$icons/an.png"
icon[aus]="$icons/aus.png"
path="/home/$user/Desktop"

[[ -f $config ]] && source $config

socket="$1:$2"
zustand="$3"
file="$path/$socket.desktop"

# create a desktop icon:
mkdir -p $path
cat > $file << EOF
#!/usr/bin/env xdg-open
[Desktop Entry]
Version=1.0
Type=Application
Terminal=false  
Exec=steckdose $socket um
Name=$(steckdose $socket name)
Icon=${icon[$zustand]}
EOF
chown $user $file
chmod +x $file


# create another desktop item for new power service
state=("$icons/aus.png" "$icons/an.png")
file="$path/new_$socket.desktop"
cat > $file << EOF
#!/usr/bin/env xdg-open
[Desktop Entry]
Version=1.0
Type=Application
Terminal=false  
Exec=signal :power power toggle name usb
Name=$socket
Icon=${state[0]}
EOF
chown $user $file
chmod +x $file
