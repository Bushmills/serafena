# named groups of hosts
# @HELP signal host group				# show all groups
# @HELP signal host group name				# show members of group name
# @HELP signal host group name =			# delete group
# @HELP signal host group name = host1 host2 host3 ...	# assign host1 host2 host3 to group name
# @HELP signal host group name += host1 host2 host3 ...	# add host1 host2 host3 to group name
# @HELP signal host group name -= host1 host2 host3	# remove host from group. single host only
# @HELP signal host group name member host		# is host member of group?
# @HELP signal host group name dead			# diagnostic on group members: report members which aren't responding to pings
# @TODO change subcommand dispatch away from that nested conditionals structure


group="${1//[!a-z0-9-.]/_}"				# rigorously substitute illegal chars against underscores
cmd="${2//[!a-z+=-]/_}"
#cmd="$2"
shift 2
args="${@//[!a-z0-9-.]/_}"
d="$groups/$group"
mkdir -p $d &&
cd $d &&
if [[ -z "$group" ]]; then
   for d in *; do   
      [[ -d $d ]] && rmdir --ignore-fail-on-non-empty $d
      [[ -d $d ]] && printf '%-20s %s\n' "$d" "$(members $d)"
   done
elif [[ -z $cmd ]]; then				# signal host group foo

#   members=(*)						# read list of group member
#   [[ -f $members ]] && 
#   echo ${members[@]}
   members $group

elif [[ $cmd == "=" ]]; then				# signal host group foo =
   rm -f *
   [[ ! -z $args ]] && touch $args
elif [[ $cmd == "+=" ]]; then				# signal host group foo +=
   [[ ! -z $args ]] && touch $args 			# signal host group foo += host(s)
elif [[ $cmd == "-=" ]]; then				# signal host group foo -= host
   [[ ! -z $args ]] && rm -f $args
elif [[ $cmd == "member" ]]; then			# signal host group name member name
   shift
   [[ ! -f $args ]]
   echo $?
elif [[ $cmd == dead ]]; then
   fping -u -r1 * 2>&1 | sed 's/ .*//'
else
   fatal "service group received wrong arguments"
fi
true
